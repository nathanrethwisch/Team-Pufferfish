---
title: Analysis of Vehicular Crashes in Iowa
affiliation:
  ## use one only of the following
  # author-columnar: true         ## one column per author
  institution-columnar: true  ## one column per institution (multiple autors eventually)
  # wide: true                  ## one column wide author/affiliation fields

  #author:   ## A custom author ordering field that breaks institution grouping.
  #  - name: Eldon Tyrell
  #    mark: 4
  #    email: eldon@starfleet-academy.star
  #  - name: Michael Shell
  #    mark: 1
  #  - name: Roy Batty
  #    mark: 4
  #    email: roy@replicant.offworld
  ## Authors cited in institution field are ignored when author field exists

  #author_multiline: ## Put authors in a given order, with multiline possibility. Authors cited in institution are ignored if exists
  #  - line:         ## Create a new author line
  #    - name: Michael Shell
  #      mark: 1
  #    - name: Homer Simpson
  #      mark: 2
  #      email: homer@thesimsons.com
  #    - name: Roy Batty
  #      mark: 4
  #      email: roy@replicant.offworld
  #  - line:         ## Create a second author line
  #    - name: Montgomery Scott
  #      mark: 3
  #    - name: Eldon Tyrell
  #      mark: 4

  institution:
    - name: Iowa State University
      department: Data Science
      location: Ames, IA 50011
      email: youremail@iastate.edu
      mark: 1
      author:
        - name: Nathan Rethwisch
    - name: Iowa State University
      department: Statistics
      location: Ames, IA 50011
      email: youremail@iastate.edu
      mark: 2
      author:
        - name: Zachary Swayne
keywords: ["keyword 1", "keyword 2"]
abstract: |
  The abstract goes here.
  On multiple lines eventually.

# use some specific Tex packages if needed. 
# with_ifpdf: true
# with_cite: true
# amsmath need to be true to use with bookdown for referencing equations.
with_amsmath: true
# with_algorithmic: true
# with_array: true
# with_dblfloatfix: true

bibliography: references.bib
output:
  bookdown::pdf_book:
    base_format: rticles::ieee_article
#citation_sorting: none   ## used as sorting option of the biblatex package (if selected)
---

\clearpage <!-- start the intro on a new page -->

Introduction
=============

According to the @iowadot, there are over 50,000 crashes per year in Iowa alone. These crashes cause millions of dollars in property damage and, unfortunately, the loss of life, with over 300 people dying in vehicular crashes each year. It is important to gain a greater understanding of the causes of these crashes to better create prevention strategies and protect the drivers on the road. By informing drivers of potential hazardous practices, they will be better prepared and encouraged to follow safe driving practices. The goal of this report is to explore some of the correlations between crashes and driving conditions to gain a better understanding of how to make the road a safer place.

# The Data

```{r setup, cache=FALSE, echo = FALSE, message = FALSE, results = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.align = "center", out.width = "0.9\\columnwidth")

library(tidyverse)
library(rvest)
library(dplyr)
library(hms)
```

```{r data, echo = FALSE, message = FALSE, results = FALSE, warning = FALSE}
#Use this if the below code doesn't work - file must be stored on your device under the same folder.
#crashes <- read_csv("../Vehicle_Crashes_in_Iowa.csv")

crashes <- read_csv("https://media.githubusercontent.com/media/nathanrethwisch/Team-Pufferfish/main/Vehicle_Crashes_in_Iowa.csv")
```

This data set comes from the Iowa Department of Transportation \url{https://icat.iowadot.gov/} and contains data for every recorded vehicle crash between January 2009 **HH: you should set an end date. Otherwise the number of observations below will look strange**. It is updated monthly by the Iowa Department of Transportation,

In total there are 728,442 observations in the data set and `r ncol(crashes)` variables, which included information on date and time of crash, location, the number of passengers, the severity of the crash measured in property damage, number of injuries, or fatalities; the weather and road conditions, and whether or not the driver was driving under the influence.

**HH: move the number of crashes by day up here to give an overview first**

**HH:  move the next paragraph to the appendix**

Data cleaning included changing empty strings and illogical values into NA values. Day, month, and year values were extracted using R's lubridate package. Latitude and longitude was columns were also created from the 'Position' column to further explore where crashes happen in Iowa.

```{r wrangling, echo = FALSE, message = FALSE, results = FALSE, warning = FALSE}
#Making blank and N/A value in NA
crashes$`City Name`[crashes$`City Name` == ""] <- NA
crashes$`County Name`[crashes$`County Name` == ""] <- NA
crashes$`Route with System`[crashes$`Route with System` == ""] <- NA
crashes[crashes=="N/A"]<-NA

#Total Number of Occupants is sometimes listed as 777 which is illogical
crashes$`Total Number of Occupants`[crashes$`Total Number of Occupants` == 777] <- NA


#Checking NA sums after we made changes to the dataset
colSums(is.na(crashes))

```

```{r wrangling2, echo = FALSE, message = FALSE, warning = FALSE, results = FALSE}
crashes$`Date of Crash` <- lubridate::mdy(crashes$`Date of Crash`)

#Creating a new columns that are separate for year, month, and day
crashes <- crashes%>%
  separate(col = `Date of Crash`, into = c("Year", "Month", "Day"), remove =
             FALSE, sep = "-")
```

```{r wrangling3, echo = FALSE, message = FALSE, warning = FALSE, results = FALSE}
#Getting the distinct latitude and longitude
crashes<- crashes%>%
  separate(col = Location, into = c(NA, "Latitude", "Longitude"), remove =
             FALSE, sep = " ")

crashes<- crashes%>%mutate(Latitude = parse_number(Latitude), Longitude = parse_number(Longitude))
```

```{r map, echo = FALSE, message = FALSE, results = FALSE}
#Map of all crashes in Iowa. This shows that the data comes from all over the state
# crashes%>%
#       ggplot(aes(x = Latitude, y = Longitude)) + geom_point()
```

# Sunrise/Sunset Analysis

After cleaning the data, our analysis focused on how time of the day when car crashes happen. We hypothesize that more crashes will happen in the morning and evening as the driver is travelling into the sun and has to deal with sun glare, preventing them from seeing clearly.

## Data Extraction

Because evening and morning times are variable throughout the year, one must look at when the sun is rising and setting. Because this data was not included in the original data set, the data was scraped from @timeanddate. The data includes sunrise and sunset times for Ames, Iowa in 2020. The reasoning behind using Ames was that it is the nearest major town to the geographical center of Iowa. This would limit variation of sunrise and sunset times based on location. For approximately every 70 miles, there is a one minute change in sunrise and sunset times. By using Ames, these discrepancies to under three minutes. The year 2020 was chosen because it is the most recent leap year and would provide meaningful data for February 29.

Figure \@ref(fig:timeanddate) shows an example table from timeanddate that was used for the data collection is as follows:

```{r timeanddate, fig.cap="Example table of the data collected for sunrise and sunset times."}
knitr::include_graphics("../images/paste-5719206D.png")
```

Using a function, the data was extracted for each month in 2020 and joined with the original crash data set.

```{r load_sun}
if (!file.exists("../data/ames-sunset-sunrise-2020.csv")) source("../code/timeanddata-scrape.R")

sun <- read_csv("../data/ames-sunset-sunrise-2020.csv")
```

```{r, echo = FALSE, message = FALSE, results = FALSE}
crashes$Month<- gsub("Month ", "\\1", crashes$Month)
crashes$Month<- parse_integer(crashes$Month)

crashes$Day <- sub("^0+", "", crashes$Day)       
crashes$Day<- parse_integer(crashes$Day)
```

```{r, echo = FALSE, message = FALSE, results = FALSE}
#I needed to convert the Date back to integer so I could join with original data
sun$Date <- as.integer(sun$Date)
  
#Joining the original data and scraped data by day and month
df<- left_join(crashes, sun, by = c("Day" = "Date", "Month" = "Month"))
```

```{r, echo = FALSE, message = FALSE, results = FALSE}
#Finding the difference between the sunset time and the time of the crash
df$sunsetDiff = difftime(df$`Time of Crash`, df$`Sunset Time`, unit = 'mins')
df$sunriseDiff = difftime(df$`Time of Crash`, df$`Sunrise Time`, unit = 'mins')
df$sunDiff <- with(df,pmin(abs(sunsetDiff), abs(sunriseDiff)))

```

## Sunrise/Sunset Analysis

Figure \@ref(fig:sunrise) shows the minutes from sunrise compared to number of crashes, with a line denoting when the sunrise time is:

```{r sunrise,  fig.cap="A graph of all crashes by the difference between crash time and sunrise."}
#A graph of all crashes by the difference between crash time and sunrise
df%>%
  group_by(sunriseDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunriseDiff, y = n)) + geom_line() + ylab("Number of Crashes") + xlab("Minutes From Sunrise") + geom_vline(xintercept = 0)
```

This clearly appears that there is a small spike, starting right before the sun rises.

There also seems to be a noticeable spike around 750 minutes after sunrise time. This likely corresponds to sunset time, so it is only logical to look at how sunset time affects car crashes. Figure \@ref(fig:sunset) shows the minutes away from sunset, with a line denoting where the sun sets.

```{r sunset, fig.cap="A graph of all crashes by the difference between crash time and sunset"}
#A graph of all crashes by the difference between crash time and sunset
df%>%
  group_by(sunsetDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunsetDiff, y = n)) + geom_line()+geom_vline(xintercept = 0)+ xlab("Minutes from Sunset")+ylab("Number of Crashes")
```

There appears to be a pretty drastic jump right after the sun sets. According to the @duskdawn, driving at dusk is extremely dangerous, as one's eyes take time to adjust to the relative darkness, shadows hide animals and road features, and driver sometimes fail to turn on their headlights. This may be a reason why there is such a strong correlation between sunset time and a spike in car crashes.

## Daylight Analysis

One point of note is looking into how the length of the day affects car crashes. The following graph shows the number of crashes based on the length of the day. A line of best fit was added to the graph using LOESS smoothing.

There seems to be more variability in earlier months, but overall a downward trend.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
df%>%group_by(Daylight)%>%
  summarise (n = n())%>%
  ggplot(aes(x = Daylight, y = n)) + geom_point() + ylab("Number of Crashes") + geom_smooth(span = 0.3)
```

There is very clearly a downward trend, showing that there is a correlation to fewer daylight hours and more crashes.

### Conclusion:

A number of conclusions can be drawn from this data analysis. First, we can conclude that there is a correlation between sunset and sunrise time and frequency of crashes. The 30-minute window after the sun sets, especially, is correlated with an increase in crashes in Iowa. There is also a correlation between higher numbers of crashes and fewer daylight hours, but this may be correlated with the winter months being more dangerous for drivers. For future research, we would like to to further look into how rush hour traffic may affect these trends.

## Alcohol Analysis

For my analysis, I would like to look into the relationship between alcohol and car crashes. I especially want to look into how the severity of car crashes and alcohol are related and what times are the most dangerous in terms of drunk drivers.

The main data set has a variable titled "Drug or Alcohol" with eight different levels. However, only two of these levels signify that substances were not involved. Because of this I created a helper variable titled "Drug_Usage" that is TRUE when there are substances involved and FALSE when there is none present.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}

# Creates new data set to do modifications on
c <- crashes

# Changes the drug or alcohol column to a factor so that all the levels can be
# found
c$`Drug or Alcohol` <- as.factor(c$`Drug or Alcohol`)

# Finds the levels of the column
levels(c$`Drug or Alcohol`)

c %>%
  filter( (`Drug or Alcohol` == "None Indicated") | (`Drug or Alcohol` == "Refused")) %>%
  select(`Drug or Alcohol`)

# Creates new column that combines all the levels of substance abuse
c <- c %>%
  mutate(Drug_Usage = 
           (`Drug or Alcohol` != "None Indicated") &
           (`Drug or Alcohol` != "Refused"))

```

In order to perform further calculations, I also created some helper variables containing the total of crashes with and without alcohol, respectively.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Total number of crashes without substance abuse
(false_rows <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Amount of Property Damage`) %>%
  nrow())

# Total amount of crashes with substance abuse
(true_rows <- nrow(c) - false_rows)
```

After that, I found the average property damage that results from crashes with and without drunk driving. As I expected, drunk crashes do cause more damage, almost \$3000 more on average.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Total cost of crashes without substance abuse
(false_total_cost <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Amount of Property Damage`) %>%
  sum(na.rm=TRUE))

# Total cost of crashes with substance abuse
(true_total_cost <- c %>%
  filter(Drug_Usage == TRUE) %>%
  select(`Amount of Property Damage`) %>%
  sum(na.rm=TRUE))
  
# Average property damage of crash without substance abuse
false_total_cost / false_rows

# Average property damage of crash with substance abuse
true_total_cost / true_rows

```

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
c %>%
  group_by(Drug_Usage) %>%
  summarise(mean = mean(`Amount of Property Damage`,na.rm=TRUE)) %>%
  ggplot(aes(x=Drug_Usage, y=mean)) + 
  geom_col() + xlab("Alcohol Usage") + ylab("Average Property Damage") +
  ggtitle("Average Property Damage by Alcohol Usage")
```

I also looked at the average fatalities per crash with and without alcohol. The actual values of the averages aren't super intuitive, as they are small decimals, but finding the average rate of fatalities is much more useful. When doing so, fatalities occur in sober crashes about 1 in 217 crashes, while fatalities in drunk crashes occur at about 1 in 20. This difference in fatality is expected, but I am shocked at how much higher it truly is.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Total number of fatalities with and without substance abuse
(false_total_fatal <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Number of Fatalities`) %>%
  sum(na.rm=TRUE))

(true_total_fatal <- c %>%
  filter(Drug_Usage == TRUE) %>%
  select(`Number of Fatalities`) %>%
  sum(na.rm=TRUE))

# Average fatalities per accident without substance abuse
false_total_fatal / false_rows

# Average fatalities per accident with substance abuse
true_total_fatal / true_rows

```

Next, I decided to look into how time of day affects drunk driving. I plotted sober and drunk crashes and tried to find a pattern.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
c <- c %>%
  mutate(Hour = parse_number(Hour))

# Plot of all crashes by the hour
c %>%
  ggplot(aes(x=Hour)) + geom_bar()
# Most crashes happen during "rush hour" from 4 to 6 P.M.

# Plot of all crashes with sustance abuse by the hour
c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=Hour)) + geom_bar()
# Most crashes with substances involved happen from 11 P.M. to 3 A.M.
```

After that, I decided to try and find what percentage of crashes that occur during late night hours involve alcohol. To do so, I created a helper variable containing all crashes that occurred between 10 P.M. and 4 A.M.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Contains only crashes occuring between 10 P.M. and 4 A.M.
c_night <- c %>%
  filter(Hour >= 22 | Hour <= 4)

# Total number of night crashes
(total_night <- nrow(c_night))

# Total number of crashes with drug usage during the night
(true_total_night <- c_night %>%
  filter(Drug_Usage == TRUE) %>%
  nrow())
```

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Crashes with substances are 4% of all crashes
true_rows / nrow(c)

# Crashes with substances are 14% of all crashes from 10 P.M. to 3 A.M.
true_total_night / total_night

```

The next unit of time I decided to look at was day of the week. I expected to see a large spike on weekends, especially on Friday and Saturday. To do so, I once again plotted both sober and drunk crashes by day of the week and compared them.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Plot of all crashes by day of the week
c %>%
  ggplot(aes(x=`Day of Week`)) + geom_bar() + theme(axis.text.x = element_text(angle = 45))
# Crashes occur pretty much uniformly throughout the week
#
# Slight uptick on Friday, people driving home more recklessly to get
# home faster?

# Plot of all crashes with substance abuse by day of the week
c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=`Day of Week`)) + geom_bar() + theme(axis.text.x = element_text(angle = 45))
# Majority of these crashes occur on the weekends, Saturday and Sunday are
# likely higher than Friday because they happen early in the "morning" after
# Friday and Saturday nights

```

Finally, I looked at crashes by day of the year. There is no real pattern in by day of the year, but there are a few outliers. Both New Year's day and the Fourth of July have a very large amount of drunk crashes in comparison to the rest of the year. This first graph shows all drug-related crashes:

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Plot of crashes with drug usage by day of the year
c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=Day)) + geom_bar() + facet_wrap(~Month)
# No real pattern except for two huge outliers, New Year's Day and the Fourth of # July
```

Figure \@ref(fig:avgcrashes) shows the average number of crashes in Iowa by day of year. 

```{r avgcrashes, out.width="\\columnwidth", fig.cap="Average number of crashes by day of the year. Spring and summer months see on average fewer crashes than the rest of the year. From November to February, we see an increased variability in the number of crashes -- this is likely due to bad weather days in some of the years. There is a clear holiday effect in the number of crashes: Jan 1, July 4, Thanksgiving, and, in particular, Christmas day and the day after have a much-reduced number of crashes. However, both New Year's day and the Fourth of July have a very large amount of drunk crashes in comparison to the rest of the year (shown in orange). "}

## Plot of all crashes by day of the year
#c %>%
#  ggplot(aes(x=Day)) + geom_bar() + facet_wrap(~Month)

drugs <- c %>% 
  filter(Drug_Usage == TRUE) %>%
  group_by(Year, Month, Day) %>% count() %>% 
  ungroup(Year) %>% summarize(avg=mean(n))

# Plot of average number of crashes by day of the year
c %>% group_by(Year, Month, Day) %>% count() %>% 
  ungroup(Year) %>% summarize(avg=mean(n)) %>% ggplot(aes(x=Day,y=avg)) + 
  geom_bar(stat="identity", fill="grey50") + 
  geom_bar(aes(y=avg*5), stat="identity", data = drugs, fill="darkorange") + 
  facet_wrap(~Month) + theme_bw() + 
  xlab("Day of the Month") +
  scale_y_continuous(
    # Features of the first axis
    name = "Average number of crashes",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./5, name="Drugs (alcohol) involved")
  ) +
  theme(
    axis.title.y = element_text(color = "grey50", size=13),
    axis.text.y = element_text(color = "grey50"),
    axis.title.y.right = element_text(color = "darkorange", size=13),
    axis.text.y.right = element_text(color = "darkorange")
  )
```

The fact that New Year's day has triple the amount of drug-involved crashes as any other day is particularly scary because January first has the lowest amount of overall crashes in the month of January.

```{r, results = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Plot of crashes by days in January
c %>%
  filter(Month == 1) %>%
  ggplot(aes(x=Day)) + geom_bar()
# New Year's Day actually has the least amount of crashes in January, but the
# most amount of drunk crashes
```

## Conclusion

1.  Alcohol drastically increases the danger and severity of crashes: fatalities, injuries, and property damage all occur at an increased rate.

2.  Nighttime and Friday and Saturday nights are the times with the most drunk driving, so it may be wise to avoid the roads at those times.

3.  The worst nights to drive on are New Year's Eve and the Fourth of July, as they by far have the most drunk accidents of any other days in the year.






Conclusion
============
The conclusion goes here.

<!-- conference papers do not normally have an appendix -->


\clearpage

Appendix {#appendix .unnumbered}
==========

# Data Cleaning

# Data on Sunsets and Sunrises

\clearpage
References {#references .numbered}
==========
