---
output: html_document
---

I love pufferfish

The goal of our project is to find what variables are most prominent when causing crashes that are fatal, have significant crash severity, or cause the most property damage. The variables we are looking at right now include roadway type, roadway surface, environmental/weather conditions, and light conditions. Eventually, we would like to create a model to predict what conditions are most likely to cause serious injuries.

Nathan:

In addition to this, I will be exploring the relationship accidents and time of day. I want to see if certain things like driving into the sun or driving at night result in a significant increase in accidents. I hypothesize that crashes will increase when going eastbound during the morning and decrease in the evening. For westbound drivers, the opposite should be true- crashes will increase in the evening/afternoon and decrease in the morning.

Zack:

I will be exploring the relationship between accidents as they are related to alcohol or substance use and time of week. I want to see if substance related accidents cause more property damage and/or injuries and if substance related accidents are more likely to occur at night or on the weekends. I hypothesize that alcohol based incidents will results in more damage than normal accidents, and that alcohol and other substance based accidents will happen more often at night and on the weekends.

-We have not heard from Calvin

```{r}
library(tidyverse)

#Use this if the below code doesn't work - file must be stored on your device.
#crashes <- read.csv("../Vehicle_Crashes_in_Iowa.csv")
crashes <- read_csv("https://media.githubusercontent.com/media/nathanrethwisch/Team-Pufferfish/main/Vehicle_Crashes_in_Iowa.csv")

```

```{r}

dim(crashes)
str(crashes)

#NA values are only found in a few values?
colSums(is.na(crashes))

#This is strange because it appears that Weather Conditions has NA values
sum(is.na(crashes$`Weather Conditions`))

#Making blank and N/A value in NA
crashes$`City Name`[crashes$`City Name` == ""] <- NA
crashes$`County Name`[crashes$`County Name` == ""] <- NA
crashes$`Route with System`[crashes$`Route with System` == ""] <- NA
crashes[crashes=="N/A"]<-NA
crashes$`Total Number of Occupants`[crashes$`Total Number of Occupants` == 777] <- NA

#Making the case number an integer
crashes$`Law Enforcement Case Number` <- as.integer(crashes$`Law Enforcement Case Number`)

#Checking NA sums after we made changes to the dataset
colSums(is.na(crashes))

```

```{r}
#Getting the distinct latitude and longitude
crashes<- crashes%>%
  separate(col = Location, into = c(NA, "Latitude", "Longitude"), remove =
             FALSE, sep = " ")

crashes<- crashes%>%mutate(Latitude = parse_number(Latitude), Longitude = parse_number(Longitude))
```

```{r}
crashes$`Date of Crash` <- lubridate::mdy(crashes$`Date of Crash`)

#Creating a new columns that are separate for year, month, and day
crashes <- crashes%>%
  separate(col = `Date of Crash`, into = c("Year", "Month", "Day"), remove =
             FALSE, sep = "-")
#View(crashes)
```

```{r}
#Looking at the different crash severities
crashes%>%
  group_by(`Crash Severity`)%>%
  summarise(n = n())
```

```{r}
#Roadway contribution to fatal car accidents
crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  group_by(`Roadway Contribution`)%>%
  summarise(n = n())
```

```{r}
#The count of roadway contributions by injury severity
crashes%>%
  ggplot(aes(x = `Roadway Contribution`)) +geom_bar() + facet_wrap(~`Crash Severity`)+coord_flip()
```

```{r}
#Map of all crashes in Iowa
crashes%>%
      ggplot(aes(x = Latitude, y = Longitude)) + geom_point()
```

```{r}
#Crash severity grouped by roadway type
crashes2<- crashes%>%
  group_by(`Roadway Type`, `Crash Severity`)%>%
  summarise(n = n())

crashes2[which.max(crashes2$n),]

```

```{r}
#The top cause of fatal crashes
crashes3<- crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  group_by(`Major Cause`)%>%
  summarise(n = n())

crashes3[which.max(crashes3$n),]
```

```{r}
#Looking at the top environmental and surface conditions for fatal accidents
Cause_crashes<- crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  group_by(`Environmental Conditions`, `Light Conditions`, `Surface Conditions`, `Weather Conditions`)%>%
  summarise(n = n())

Cause_crashes%>%filter(n > 100)
```

```{r}
#Barplot of fatal crashes by light condition
crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  ggplot(aes(x = `Light Conditions`)) +geom_bar() + coord_flip()
```

```{r fig.height = 10, fig.width = 10}
#Fatal Crashes by Day
crashes%>%
  group_by(Month)%>%
  filter(`Crash Severity` == "Fatal")%>%
  ggplot(aes(x = Day, fill = `Crash Severity`)) +geom_bar() + facet_wrap(~Month) + coord_flip()
```

```{r, fig.height = 15, fig.width = 15}
#All types of crashes by month
crashes%>%
  group_by(Month)%>%
  ggplot(aes(x = Day, fill = `Crash Severity`)) +geom_bar() + facet_wrap(~Month)
```

```{r}
crashes%>%
  filter(`Amount of Property Damage`<100000)%>%
  ggplot(aes(x = `Amount of Property Damage`, y = `Number of Injuries`)) + geom_point()
  
  
```

```{r}
crashes%>%
  filter(`Amount of Property Damage`<100000)%>%
  ggplot(aes(x = `Amount of Property Damage`, y = `Number of Minor Injuries`)) + geom_point()
```

```{r}
crashes%>%
  filter(`Amount of Property Damage`<100000)%>%
  ggplot(aes(x = `Amount of Property Damage`, y = `Number of Major Injuries`)) + geom_point()
```

```{r}
#Crashes by direction
crashes$Hour<- gsub("Hour ", "\\1", crashes$Hour)
crashes$Hour<- parse_integer(crashes$Hour)
#View(crashes)


crashes<- crashes %>% mutate(TimesOfDay =
                     case_when((Hour >20) | (Hour <=5) ~"Night",
                               (Hour >5) & (Hour <=11) ~"Morning",
                               (Hour >=12) & (Hour <18) ~"Afternoon",
                               (Hour >=18) & (Hour <21) ~"Evening")
)
#View(crashes)

crashes%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'))%>%
  ggplot(aes(x = `Travel Direction`, fill = `TimesOfDay`)) + geom_bar() + coord_flip()


```

```{r}
#Fatal crashes per month by time of day
crashes%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'), `Crash Severity` == "Fatal")%>%
  ggplot(aes(x = `Travel Direction`, fill = `TimesOfDay`)) + geom_bar() + coord_flip() + facet_wrap(~Month)
```

```{r}
crashes%>%
  filter(`Month` == "08", `Crash Severity` == "Fatal", `Travel Direction` == "Eastbound (EB)")%>%
  group_by(Day)%>%
  summarise(n = n())
```

```{r}
crashes%>%
  filter(`Month` == "06", `Crash Severity` == "Fatal", `Travel Direction` == "Westbound (WB)")%>%
  group_by(Day)%>%
  summarise(n = n())
```

```{r}
#All crashes by month and time of day and direction of travel
crashes%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'))%>%
  ggplot(aes(x = `Travel Direction`, fill = `TimesOfDay`)) + geom_bar() + coord_flip() + facet_wrap(~Month)
```

```{r}
crashes%>%
  ggplot(aes(x = `Hour`)) + geom_bar() + facet_wrap(~Month)

```

\# if (any(final_weather == "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)")){

\# final_weather \<-final_weather[-which(final_weather\$Sunrise == "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)"),]

\# } else if (any(final_weather == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)")){

\# final_weather \<- final_weather[-which(final_weather\$Sunrise == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)")]

\# }

```{r}

#install.packages("rvest")
library(rvest)
library(dplyr)
page <- read_html("https://www.timeanddate.com/sun/@4846834?month=3&year=2020")
tables <- page %>% html_table(fill = TRUE)
tables %>% str
weather<- tables[[2]]

names(weather)[1] <- "Date"
names(weather)[2] <- "Sunrise"
names(weather)[3] <- "Sunset"
#View(weather)
weather2 <-weather[14:16]
#View(weather)
names(weather2)[1] <- "Date"
names(weather2)[2] <- "Sunrise"
names(weather2)[3] <- "Sunset"
#View(weather)

weather2$Date <- as.character(weather2$Date)
weather <- weather[1:3]

final_weather <- full_join(na.omit(weather), na.omit(weather2))
final_weather[1,]<- final_weather[nrow(final_weather),]
final_weather <- final_weather[-2,]
final_weather <- final_weather[-nrow(final_weather)+1: -nrow(final_weather),]

if (any(final_weather == "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)")){
  final_weather <-final_weather[-which(final_weather$Sunrise ==  "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)"),]
} else if (any(final_weather == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)")){
  final_weather <- final_weather[-which(final_weather$Sunrise == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)"),]
}

View(final_weather)



#Ones that are debatable
#final_weather$Month <- 3
```

```{r}
library(rvest)
library(dplyr)
library(hms)
dfmonth <- function(url, number) {
page <- read_html(url)
tables <- page %>% html_table(fill = TRUE)
tables %>% str
weather<- tables[[2]]

names(weather)[1] <- "Date"
names(weather)[2] <- "Sunrise"
names(weather)[3] <- "Sunset"
#View(weather)
weather2 <-weather[14:16]
#View(weather)
names(weather2)[1] <- "Date"
names(weather2)[2] <- "Sunrise"
names(weather2)[3] <- "Sunset"
#View(weather)

weather2$Date <- as.character(weather2$Date)
weather <- weather[1:3]

final_weather <- full_join(na.omit(weather), na.omit(weather2))
final_weather[1,]<- final_weather[nrow(final_weather),]
final_weather <- final_weather[-2,]
final_weather <- final_weather[-nrow(final_weather)+1: -nrow(final_weather),]

if (any(final_weather == "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)")){
  final_weather <-final_weather[-which(final_weather$Sunrise ==  "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)"),]
} else if (any(final_weather == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)")){
  final_weather <- final_weather[-which(final_weather$Sunrise == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)"),]
}

final_weather$Month <- number
  
final_weather<-final_weather%>%
  separate(col = Sunrise, into = c("Sunrise Time", NA), remove = TRUE, sep = " ↑")

final_weather<-final_weather%>%
  separate(col = Sunset, into = c("Sunset Time", NA), remove = TRUE, sep = " ↑")

final_weather$`Sunset Time` <- format(strptime(final_weather$`Sunset Time`, "%I:%M %p"), format="%H:%M:%S")

final_weather$`Sunrise Time` <- format(strptime(final_weather$`Sunrise Time`, "%I:%M %p"), format="%H:%M:%S")

final_weather$`Sunrise Time` <- as_hms(final_weather$`Sunrise Time`)
final_weather$`Sunset Time` <- as_hms(final_weather$`Sunset Time`)

  return (final_weather)
}

```

```{r}
sun<- dfmonth("https://www.timeanddate.com/sun/@4846834?month=1&year=2020", 1)
for (i in 2:12){
  url<- paste0("https://www.timeanddate.com/sun/@4846834?month=", i, "&year=2020")
  dfTemp<- dfmonth(url, i)
  sun<- full_join(sun, dfTemp)
  
}
View(sun)
```

```{r}
crashes%>%
  ggplot(aes(x = `Time of Crash`)) + geom_bar() + facet_wrap(~Month)
```

```{r}
crashes$Month<- gsub("Month ", "\\1", crashes$Month)
crashes$Month<- parse_integer(crashes$Month)

crashes$Day <- sub("^0+", "", crashes$Day)       
crashes$Day<- parse_integer(crashes$Day)
```

```{r}
sun$Date <- as.integer(sun$Date)
  
df<- left_join(crashes, sun, by = c("Day" = "Date", "Month" = "Month"))
View(df)
```

```{r}
df$sunsetDiff = abs(difftime(df$`Time of Crash`, df$`Sunset Time`, unit = 'mins'))
df$sunriseDiff = abs(difftime(df$`Time of Crash`, df$`Sunrise Time`, unit = 'mins'))
df$sunDiff <- with(df,pmin(sunsetDiff, sunriseDiff))
df$sunDiff

df%>%
  ggplot(aes(x = sunriseDiff)) + geom_bar() + facet_wrap(~Month)
```

```{r}
df%>%
  ggplot(aes(x = sunsetDiff)) + geom_bar() + facet_wrap(~Month)
```

```{r}

```
