---
output:
  word_document: default
  html_document: default
---

I love pufferfish

The goal of our project is to find what variables are most prominent when causing crashes that are fatal, have significant crash severity, or cause the most property damage. The variables we are looking at right now include roadway type, roadway surface, environmental/weather conditions, and light conditions. Eventually, we would like to create a model to predict what conditions are most likely to cause serious injuries.

Nathan:

In addition to this, I will be exploring the relationship accidents and time of day. I want to see if certain things like driving into the sun or driving at night result in a significant increase in accidents. I hypothesize that crashes will increase when going eastbound during the morning and decrease in the evening. For westbound drivers, the opposite should be true- crashes will increase in the evening/afternoon and decrease in the morning.

Zack:

I will be exploring the relationship between accidents as they are related to alcohol or substance use and time of week. I want to see if substance related accidents cause more property damage and/or injuries and if substance related accidents are more likely to occur at night or on the weekends. I hypothesize that alcohol based incidents will results in more damage than normal accidents, and that alcohol and other substance based accidents will happen more often at night and on the weekends.

```{r}
library(tidyverse)

#Use this if the below code doesn't work - file must be stored on your device.
crashes <- read_csv("../Vehicle_Crashes_in_Iowa.csv")
#View(crashes)
#crashes <- read_csv("https://media.githubusercontent.com/media/nathanrethwisch/Team-Pufferfish/main/Vehicle_Crashes_in_Iowa.csv")

```

```{r}

dim(crashes)
str(crashes)

#NA values are only found in a few values?
colSums(is.na(crashes))

#This is strange because it appears that Weather Conditions has NA values
sum(is.na(crashes$`Weather Conditions`))

#Making blank and N/A value in NA
crashes$`City Name`[crashes$`City Name` == ""] <- NA
crashes$`County Name`[crashes$`County Name` == ""] <- NA
crashes$`Route with System`[crashes$`Route with System` == ""] <- NA
crashes[crashes=="N/A"]<-NA
crashes$`Total Number of Occupants`[crashes$`Total Number of Occupants` == 777] <- NA

#Making the case number an integer
crashes$`Law Enforcement Case Number` <- as.integer(crashes$`Law Enforcement Case Number`)

#Checking NA sums after we made changes to the dataset
colSums(is.na(crashes))

```

```{r}
#Getting the distinct latitude and longitude
crashes<- crashes%>%
  separate(col = Location, into = c(NA, "Latitude", "Longitude"), remove =
             FALSE, sep = " ")

crashes<- crashes%>%mutate(Latitude = parse_number(Latitude), Longitude = parse_number(Longitude))
```

```{r}
crashes$`Date of Crash` <- lubridate::mdy(crashes$`Date of Crash`)

#Creating a new columns that are separate for year, month, and day
crashes <- crashes%>%
  separate(col = `Date of Crash`, into = c("Year", "Month", "Day"), remove =
             FALSE, sep = "-")
#View(crashes)
```

```{r}
#Looking at the different crash severities
crashes%>%
  group_by(`Crash Severity`)%>%
  summarise(n = n())
```

```{r}
#Roadway contribution to fatal car accidents
crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  group_by(`Roadway Contribution`)%>%
  summarise(n = n())
```

```{r}
#The count of roadway contributions by injury severity
crashes%>%
  ggplot(aes(x = `Roadway Contribution`)) +geom_bar() + facet_wrap(~`Crash Severity`)+coord_flip() + ylab("Number of Crashes")
```

```{r}
#Map of all crashes in Iowa. This shows that the data comes from all over the state
crashes%>%
      ggplot(aes(x = Latitude, y = Longitude)) + geom_point()
```

```{r}
#Crash severity grouped by roadway type
crashes2<- crashes%>%
  group_by(`Roadway Type`, `Crash Severity`)%>%
  summarise(n = n())

crashes2[which.max(crashes2$n),]

```

```{r}
#The top cause of fatal crashes
crashes3<- crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  group_by(`Major Cause`)%>%
  summarise(n = n())

crashes3[which.max(crashes3$n),]
```

```{r}
#Looking at the top environmental and surface conditions for fatal accidents
Cause_crashes<- crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  group_by(`Environmental Conditions`, `Light Conditions`, `Surface Conditions`, `Weather Conditions`)%>%
  summarise(n = n())

Cause_crashes%>%filter(n > 100)
```

```{r}
#Barplot of fatal crashes by light condition
crashes%>%
  filter(`Crash Severity` == "Fatal")%>%
  ggplot(aes(x = `Light Conditions`)) +geom_bar() + coord_flip()+ylab("Number of Crashes")
```

```{r fig.height = 10, fig.width = 10}
#Fatal Crashes by Day
crashes%>%
  group_by(Month)%>%
  filter(`Crash Severity` == "Fatal")%>%
  ggplot(aes(x = Day, fill = `Crash Severity`)) +geom_bar() + facet_wrap(~Month) + coord_flip() + ylab("Number of Crashes")
```

```{r, fig.height = 15, fig.width = 15}
#All types of crashes by month
crashes%>%
  group_by(Month)%>%
  ggplot(aes(x = Day, fill = `Crash Severity`)) +geom_bar() + facet_wrap(~Month)+ylab("Number of Crashes")
```

```{r}
#Number of injuries for crashes with under $100,000 in property damage
crashes%>%
  filter(`Amount of Property Damage`<100000)%>%
  ggplot(aes(x = `Amount of Property Damage`, y = `Number of Injuries`)) + geom_point()
  
  
```

```{r}
#Amount of minior injuries for crashes with under $100,000 in property damage
crashes%>%
  filter(`Amount of Property Damage`<100000)%>%
  ggplot(aes(x = `Amount of Property Damage`, y = `Number of Minor Injuries`)) + geom_point()
```

```{r}
#
crashes%>%
  filter(`Amount of Property Damage`<100000)%>%
  ggplot(aes(x = `Amount of Property Damage`, y = `Number of Major Injuries`)) + geom_point()
```

```{r}
#Crashes by direction
crashes$Hour<- gsub("Hour ", "\\1", crashes$Hour)
crashes$Hour<- parse_integer(crashes$Hour)
#View(crashes)

#Creating different times of day
#9pm-4am is night
#5am-11am is morning
#12pm-5pm is the afternoon
#6pm-9pm is the evening
crashes<- crashes %>% mutate(TimesOfDay =
                     case_when((Hour >20) | (Hour < 5) ~"Night",
                               (Hour >=5) & (Hour <=11) ~"Morning",
                               (Hour >=12) & (Hour <17) ~"Afternoon",
                               (Hour >=17) & (Hour <21) ~"Evening")
)

#Plotting crashes by time of day and travel direction
#There seems to be little difference, but sunset and sunrise times are changing, so it is hard to know when sunset and sunrise actually is happening
crashes%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'))%>%
  ggplot(aes(x = `Travel Direction`, fill = `TimesOfDay`)) + geom_bar() + coord_flip() + ylab("Number of crashes")


```

```{r}
#Fatal crashes per month by time of day
crashes%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'), `Crash Severity` == "Fatal")%>%
  ggplot(aes(x = `Travel Direction`, fill = `TimesOfDay`)) + geom_bar() + coord_flip() + facet_wrap(~Month) + ylab("Number of Crashes")
```

```{r}
#Looking at above data, there seems to be a lot of fatal crashse travelling easbound in August, but there are no major crash events to cause this. Perhaps people are travelling east on the way home from vacation?
crashes%>%
  filter(`Month` == "08", `Crash Severity` == "Fatal", `Travel Direction` == "Eastbound (EB)")%>%
  group_by(Day)%>%
  summarise(n = n())
```

```{r}
#There are also a lot of crashes travelling westbound in June, maybe people are going west for the summer? This could also be thrown off due to the small amount of fatal crashes
crashes%>%
  filter(`Month` == "06", `Crash Severity` == "Fatal", `Travel Direction` == "Westbound (WB)")%>%
  group_by(Day)%>%
  summarise(n = n())
```

```{r}
#All crashes by month and time of day and direction of travel - this shows a smoother distribution
crashes%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'))%>%
  ggplot(aes(x = `Travel Direction`, fill = `TimesOfDay`)) + geom_bar() + coord_flip() + facet_wrap(~Month) + ylab("Number of Crashes")
```

```{r}
#Looking at a scatterplot of crashes by hour per month. There seem to be some pretty high peeks in the aftenoons of November and December
crashes%>%
  group_by(Hour, Month)%>%
  summarise(n = n())%>%
  ggplot(aes(x = `Hour`, y =n)) + geom_line() + facet_wrap(~Month) + ylab("Number of Crashes")
```

```{r}
#Using rvest to extract sunrise and sunset data
library(rvest)
library(dplyr)
library(hms)

#A function that takes in the url and month number
dfmonth <- function(url, number) {
  
#Extraction of the table
page <- read_html(url)
tables <- page %>% html_table(fill = TRUE)
tables %>% str
weather<- tables[[2]]

#Setting names to date, sunrise, and sunset
names(weather)[1] <- "Date"
names(weather)[2] <- "Sunrise"
names(weather)[3] <- "Sunset" 
names(weather)[4] <- "Daylight"


#The first day for each month in the dataframe is in it's own column, so I created a new dataframe with the pertinent intformation and renamed those columns
weather2 <-weather[14:17]
names(weather2)[1] <- "Date"
names(weather2)[2] <- "Sunrise"
names(weather2)[3] <- "Sunset"
names(weather2)[4] <- "Daylight"

#I then changed the Date to a character so it can be merged with the other data
weather2$Date <- as.character(weather2$Date)

#I select only the pertinent data from the original weather data set
weather <- weather[1:4]

#Next, I join the data sets while omitting NA values
final_weather <- full_join(na.omit(weather), na.omit(weather2))

#The first day in the dataset will be at the end, so I move it towards the front
final_weather[1,]<- final_weather[nrow(final_weather),]

#Next, I remove the labels that stuck onto this dataset that are unnecessary
final_weather <- final_weather[-2,]

#The last two rows are removed because they contain a copy of day 1 and some additional information from the webpage
final_weather <- final_weather[-nrow(final_weather)+1: -nrow(final_weather),]

#These loops are to deal with notices for time changes. If there is a time change notice in the dataframe, they are removed.
if (any(final_weather == "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)")){
  final_weather <-final_weather[-which(final_weather$Sunrise ==  "Note: hours shift because clocks change forward 1 hour. (See the note below this table for details)"),]
} else if (any(final_weather == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)")){
  final_weather <- final_weather[-which(final_weather$Sunrise == "Note: hours shift because clocks change backward 1 hour. (See the note below this table for details)"),]
}

#Creating a new column that corresponds to the month number
final_weather$Month <- number
  
#Seperating additional informatoin from the sunset and sunrise times in the graph
final_weather<-final_weather%>%
  separate(col = Sunrise, into = c("Sunrise Time", NA), remove = TRUE, sep = " ↑")

final_weather<-final_weather%>%
  separate(col = Sunset, into = c("Sunset Time", NA), remove = TRUE, sep = " ↑")

#Making the sunset time in Hour:Minute:Second format
final_weather$`Sunset Time` <- format(strptime(final_weather$`Sunset Time`, "%I:%M %p"), format="%H:%M:%S")

final_weather$`Sunrise Time` <- format(strptime(final_weather$`Sunrise Time`, "%I:%M %p"), format="%H:%M:%S")


#Making the data type of sunset and sunrise an hms so it can be compared to the original data
final_weather$`Sunrise Time` <- as_hms(final_weather$`Sunrise Time`)
final_weather$`Sunset Time` <- as_hms(final_weather$`Sunset Time`)
final_weather$`Daylight` <- as_hms(final_weather$`Daylight`)

#Returns the altered dataframe
  return (final_weather)
}

```

```{r}
#Creating a dataframe using my previous function in the month January
#I'm choosing 2020 because it is the most recent leap year - so I will have data for February 29th. I'm choosing Ames because it is close to the geographical center of Iowa
sun<- dfmonth("https://www.timeanddate.com/sun/@4846834?month=1&year=2020", 1)

#For the rest of the months, I run this loop and join them with the dataframe
for (i in 2:12){
  url<- paste0("https://www.timeanddate.com/sun/@4846834?month=", i, "&year=2020")
  dfTemp<- dfmonth(url, i)
  sun<- full_join(sun, dfTemp)
  
}

#Checking if there are any null values 
sum(is.na(sun$`Sunrise Time`))
sum(is.na(sun$`Date`))
sum(is.na(sun$`Sunset Time`))
sum(is.na(sun$`Daylight`))
```

```{r}
#A line chart that loooks at crashes by time of crash
crashes%>%
  group_by(`Time of Crash`)%>%
  summarise(n = n())%>%
  ggplot(aes(x = `Time of Crash`, y = n)) + geom_line() + ylab("Number of Crashes")
```

```{r}
crashes$Month<- gsub("Month ", "\\1", crashes$Month)
crashes$Month<- parse_integer(crashes$Month)

crashes$Day <- sub("^0+", "", crashes$Day)       
crashes$Day<- parse_integer(crashes$Day)
```

```{r}
#I needed to convert the Date back to integer so I could join with original data
sun$Date <- as.integer(sun$Date)
  
#Joining the original data and scraped data by day and month
df<- left_join(crashes, sun, by = c("Day" = "Date", "Month" = "Month"))
```

```{r}
#Finding the difference between the sunset time and the time of the crash
df$sunsetDiff = difftime(df$`Time of Crash`, df$`Sunset Time`, unit = 'mins')
df$sunriseDiff = difftime(df$`Time of Crash`, df$`Sunrise Time`, unit = 'mins')
df$sunDiff <- with(df,pmin(abs(sunsetDiff), abs(sunriseDiff)))

#Looking at the difference between sunset and time of the crash by month
df%>%
  group_by(Month, sunsetDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunsetDiff, y= n)) + geom_line() + facet_wrap(~Month)+geom_vline(xintercept = 0) + xlab("Minutes from Sunset")+ylab("Number of Crashes")
```

```{r}
#Looking at the difference between sunrise and time of the crash by month
df%>%
  group_by(Month, sunriseDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunriseDiff, y= n)) + geom_line() + facet_wrap(~Month)+geom_vline(xintercept = 0)+ xlab("Minutes from Sunrise")+ylab("Number of Crashes")
```

We do have some skewed left graphs - meaning crashes are more likely to be close to sunset

```{r}
#A graph of all crashes by the difference between crash time and sunset
df%>%
  group_by(sunsetDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunsetDiff, y = n)) + geom_line()+geom_vline(xintercept = 0)+ xlab("Minutes from Sunset")+ylab("Number of Crashes")
```

```{r}
#Shows the same in a scatterplot, just in case there are outliers
df%>%
  group_by(sunsetDiff)%>%
  summarise("Number of Crashes" = n())%>%
  ggplot(aes(x = sunsetDiff, y = `Number of Crashes`)) + geom_point()+geom_vline(xintercept = 0)+ xlab("Minutes from Sunset")+ylab("Number of Crashes")
```

```{r}
#A fitted line for the difference between sunset and crash time
df%>%
  group_by(sunsetDiff)%>%
  summarise("Number of Crashes" = n())%>%
  ggplot(aes(x = sunsetDiff, y = `Number of Crashes`)) + geom_smooth(method = "gam", formula = y ~ poly(x, 27)) + geom_line()+geom_vline(xintercept = 0) + xlab("Minutes from Sunset")
```

```{r}
#A graph of all crashes by the difference between crash time and sunrise, with a fitted line
df%>%
  group_by(sunriseDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunriseDiff, y = n)) + geom_line() + geom_smooth(method = "gam", formula = y ~ poly(x, 25))+geom_vline(xintercept = 0) + xlab("Minutes from Sunrise")+ylab("Number of Crashes")
```

```{r}
#Just the fitted line from the previous data
df%>%
  group_by(sunriseDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunriseDiff, y = n))+ geom_smooth(method = "gam", formula = y ~ poly(x, 25))+geom_vline(xintercept = 0)+ xlab("Minutes from Sunrise")+ylab("Number of Crashes")
```

```{r}
#Looking at sunset vs. crash time going different directions
df%>%
  group_by(sunsetDiff, `Travel Direction`)%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'))%>%
  summarise(n = n())%>%
  ggplot(aes(x = `sunsetDiff`, y = n)) + geom_line() + facet_wrap(~`Travel Direction`)+geom_vline(xintercept = 0)+ xlab("Minutes from Sunset")+ylab("Number of Crashes")
```

```{r}
#Looking at sunrise vs. crash time going different directions
df%>%
  group_by(sunriseDiff, `Travel Direction`)%>%
  filter(!is.na(`Travel Direction`), `Travel Direction` %in% c('Westbound (WB)', 'Eastbound (EB)'))%>%
  summarise(n = n())%>%
  ggplot(aes(x = `sunriseDiff`, y = n)) + geom_line() + facet_wrap(~`Travel Direction`)+geom_vline(xintercept = 0)+ xlab("Minutes from Sunrise")+ylab("Number of Crashes")
```

```{r}
#Looking at different crash severities with sunset vs. crash time
df%>%
  group_by(`Crash Severity`, sunsetDiff)%>%
  summarise(n = n())%>%
  ggplot(aes(x = sunsetDiff, y = n)) + geom_line() + facet_grid(~`Crash Severity`)+geom_vline(xintercept = 0) + xlab("Minutes from Sunset")+ylab("Number of Crashes")
```

```{r}
dfDaylight<-df%>%
group_by(Daylight, `Date of Crash`)%>%
  summarise(n = n()/length(unique(`Date of Crash`)))%>%
  mutate(uniqueDate = length(unique(`Date of Crash`)))%>%
  mutate(total = sum(n)/uniqueDate)

dfDaylight <- dfDaylight[!duplicated(dfDaylight$total), ]

dfDaylight%>%
  ggplot(aes(x = Daylight, y = total)) + geom_line()
```

```{r}
dfDaylight%>%
  ggplot(aes(x = Daylight, y = total))+ geom_smooth(method = "gam", formula = y ~ poly(x, 25))+ylab("Number of Crashes")
```

```{r}

# Creates new data set to do modifications on
c <- crashes

# Changes the drug or alcohol column to a factor so that all the levels can be
# found
c$`Drug or Alcohol` <- as.factor(c$`Drug or Alcohol`)

# Finds the levels of the column
levels(c$`Drug or Alcohol`)

c %>%
  filter( (`Drug or Alcohol` == "None Indicated") | (`Drug or Alcohol` == "Refused")) %>%
  select(`Drug or Alcohol`)

# Creates new column that combines all the levels of substance abuse
c <- c %>%
  mutate(Drug_Usage = 
           (`Drug or Alcohol` != "None Indicated") &
           (`Drug or Alcohol` != "Refused"))

```

```{r}
# Total number of crashes without substance abuse
(false_rows <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Amount of Property Damage`) %>%
  nrow())

# Total amount of crashes with substance abuse
(true_rows <- nrow(c) - false_rows)
```



```{r}
# Total cost of crashes without substance abuse
(false_total_cost <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Amount of Property Damage`) %>%
  sum(na.rm=TRUE))

# Total cost of crashes with substance abuse
(true_total_cost <- c %>%
  filter(Drug_Usage == TRUE) %>%
  select(`Amount of Property Damage`) %>%
  sum(na.rm=TRUE))

sum(c$`Amount of Property Damage`, na.rm = TRUE) / nrow(c)
  
# Average property damage of crash without substance abuse
false_total_cost / false_rows

# Average property damage of crash with substance abuse
true_total_cost / true_rows

```


```{r}
# Total number of injuries with and without substance abuse
(false_total_inj <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Number of Injuries`) %>%
  sum(na.rm=TRUE))

(true_total_inj <- c %>%
  filter(Drug_Usage == TRUE) %>%
  select(`Number of Injuries`) %>%
  sum(na.rm=TRUE))

# Average injuries per accident without substance abuse
false_total_inj / false_rows

# Average injuries per accident with substance abuse
true_total_inj / true_rows

```

```{r}
# Total number of fatalities with and without substance abuse
(false_total_fatal <- c %>%
  filter(Drug_Usage == FALSE) %>%
  select(`Number of Fatalities`) %>%
  sum(na.rm=TRUE))

(true_total_fatal <- c %>%
  filter(Drug_Usage == TRUE) %>%
  select(`Number of Fatalities`) %>%
  sum(na.rm=TRUE))

# Average fatalities per accident without substance abuse
false_total_fatal / false_rows

# Average fatalities per accident with substance abuse
true_total_fatal / true_rows

```

```{r}
c <- c %>%
  mutate(Hour = parse_number(Hour))

# Plot of all crashes by the hour
c %>%
  ggplot(aes(x=Hour)) + geom_bar()
# Most crashes happen during "rush hour" from 4 to 6 P.M.

# Plot of all crashes with sustance abuse by the hour
c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=Hour)) + geom_bar()
# Most crashes with substances involved happen from 11 P.M. to 3 A.M.

c_night <- c %>%
  filter(Hour >= 22 | Hour <= 3)

(total_night <- nrow(c_night))

(true_total_night <- c_night %>%
  filter(Drug_Usage == TRUE) %>%
  nrow())

# Crashes with substances are 4% of all crashes
true_rows / nrow(c)

# Crashes with substances are 14% of all crashes from 10 P.M. to 3 A.M.
true_total_night / total_night

```

```{r}
# Plot of all crashes by day of the week
c %>%
  ggplot(aes(x=`Day of Week`)) + geom_bar() + theme(axis.text.x = element_text(angle = 45))
# Crashes occur pretty much uniformly throughout the week
#
# Slight uptick on Friday, people driving home more recklessly to get
# home faster?

# Plot of all crashes with substance abuse by day of the week
c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=`Day of Week`)) + geom_bar() + theme(axis.text.x = element_text(angle = 45))
# Majority of these crashes occur on the weekends, Saturday and Sunday are
# likely higher than Friday because they happen early in the "morning" after
# Friday and Saturday nights

```

```{r}
c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=Month)) + geom_bar()

c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=Day)) + geom_bar() + facet_wrap(~Month)

c %>%
  filter(Drug_Usage == TRUE) %>%
  ggplot(aes(x=Day)) + geom_bar() + facet_wrap(~Year)

c %>%
  ggplot(aes(x=Day)) + geom_bar() + facet_wrap(~Month)

c %>%
  filter(Month == 12) %>%
  ggplot(aes(x=Day)) + geom_bar()

c %>%
  filter(Month == "01") %>%
  ggplot(aes(x=Day)) + geom_bar()
```

